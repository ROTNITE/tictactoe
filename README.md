# TicTacToe2 — расширенные крестики-нолики с ИИ (Qt6)

Проект с несколькими режимами игры и настраиваемым движком ИИ. Поддерживает
классическую игру и режим LinesScore, а также различные правила начала
(PieSwap/Swap2/Swap2+). Основной интерфейс на Qt6.

## Возможности
- Настраиваемый размер доски и длина победной линии.
- Два режима игры:
  - Classic: стандартная победа линией.
  - LinesScore: начисление очков за построенные линии.
- Правила начала (Opening Rules): None, PieSwap, Swap2, Swap2+.
- ИИ на минимакс + alpha-beta:
  - таблица транспозиций,
  - итеративное углубление,
  - эвристики упорядочивания ходов,
  - расширения (extensions),
  - LMR (ограниченно для LinesScore),
  - настраиваемая генерация ходов (Full/Frontier/Hybrid).
- Асинхронные вычисления ИИ и подсказок без фризов UI.
- Рекомендованная автоглубина для стабильного времени хода.

## Режимы и правила
### Classic
Победа по линии длины `winLength`.

### LinesScore
Начисление очков за построенные линии. Движок учитывает кредиты X/O.

### Запрет первого хода в центр
В режиме LinesScore первый ход X в центр запрещен **только** при
OpeningRule::None. ИИ соблюдает это правило и не фильтрует центр, если
выбраны PieSwap/Swap2/Swap2+.

## Opening Rules
- None: обычный старт.
- PieSwap: после первого хода можно поменяться сторонами.
- Swap2: расширенная процедура старта с выбором стороны.
- Swap2+: вариация Swap2 с дополнительным шагом выбора.

Выбор вариантов открытия для ИИ выполняется асинхронно, чтобы UI не зависал.

## Управление глубиной поиска
В интерфейсе доступны два режима:
- **Авто-глубина (рекоменд.)** — автоматически подбирает глубину по размеру
  доски, пресету движка и текущим настройкам. Значение depth отображается, но
  поле заблокировано. Если включено — динамическая глубина отключается.
- **Динамическая глубина** — ограничение по времени (spinTimeLimit).
  Если включено — авто-глубина отключается.

Алгоритм автоглубины учитывает:
- площадь доски,
- пресет движка (Fast/Strict),
- режим генерации ходов,
- LMR/Extensions,
- режим игры (Classic/LinesScore),
- длину победной линии (winLength),
- стадию партии (по плотности заполнения).

## ИИ и поиск
Основные элементы:
- Minimax с alpha-beta.
- Таблица транспозиций (HashMap), с контролем размера и reset.
- Упорядочивание ходов (history, killer moves, TT hint).
- Мультипоточность в Classic (LinesScore принудительно single-thread).

### MoveGen для LinesScore
Для LinesScore используется усиленная генерация:
- MUST-PLAY ходы (немедленная выгода/блок) всегда включаются.
- Динамический радиус кандидатов (r=1/2/3) при разреженной позиции.
- CAP по числу ходов применяется только после скоринга и не режет must-move.

### LMR для LinesScore
LMR применяется только для "тихих" ходов и не затрагивает тактические.
По умолчанию выключен, включается через SearchParams.

## Асинхронность и Cancel
- Подсказка и ход ИИ выполняются в фоне (QtConcurrent).
- Для Swap2/Swap2+ открытие выбирается в фоне.
- Cancel останавливает поиск через atomic cancel flags.
- stopAllAi использует мягкое ожидание без жесткого фриза UI.

## Диагностика (Debug)
В debug-режиме в консоль выводятся метрики поиска:
- nodes/sec,
- hit-rate TT,
- среднее число ходов до/после cap,
- глубина и время поиска.

## Сборка
Требования:
- C++17
- Qt6 (Widgets, Concurrent)

Пример сборки:
```
cmake -S . -B build
cmake --build build
```

Запуск:
```
./build/tictactoe2
```

## Тесты
Есть тест для открытий:
```
ctest --test-dir build -R opening_tests
```

## Структура проекта
- `mainwindow.ui/.h/.cpp` — UI и основная логика.
- `GameController.hpp` — правила игры, opening-логика, связь с ИИ.
- `MinimaxAI.hpp` — движок ИИ, поиск, генерация ходов.
- `Board.hpp` — доска и базовые операции.
- `HashMap.hpp` — таблица для транспозиций.
- `opening_tests.cpp` — тесты opening-правил.

## Локализация
Используется `tictactoe2_ru_RU.ts`. Интерфейс ориентирован на русский язык.
